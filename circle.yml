machine:
  timezone:
      America/Los_Angeles
  java:
    version: openjdk7

  services:
    - docker

  environment:
      ATSD_CONTAINER_NAME: atsd_api_test
      ATSD_PORT: 8088
      ATSD_HOST: 127.0.0.1
test:
  override:
    - docker run -d --name=$ATSD_CONTAINER_NAME --publish $ATSD_PORT:$ATSD_PORT -e axiname=$ATSD_USER -e axipass=$ATSD_PASSWORD -e timezone="Asia/Kathmandu" axibase/atsd:api_test
    - while [[ $(curl --user $ATSD_USER:$ATSD_PASSWORD --write-out %{http_code} --silent --output /dev/null http://$ATSD_HOST:$ATSD_PORT/version) != 200 ]]; do  echo "waiting to start $ATSD_CONTAINER_NAME server ..."; sleep 3; done;
    - mvn clean test -Dmaven.test.failure.ignore=false -Daxibase.tsd.api.server.name=$ATSD_HOST -Daxibase.tsd.api.server.port=$ATSD_PORT -Dlaxibase.tsd.api.username=$ATSD_USER -Daxibase.tsd.api.password=$ATSD_PASSWORD;
    - mvn jacoco:report
  post:
      - mkdir -p $CIRCLE_TEST_REPORTS/junit/
      - find . -type f -regex ".*/target/surefire-reports/.*xml" -exec cp {} $CIRCLE_TEST_REPORTS/junit/ \;
      - curl https://www.jpm4j.org/install/script | sh
      - jpm install com.codacy:codacy-coverage-reporter:assembly
      - codacy-coverage-reporter -l Java -r target/site/jacoco/jacoco.xml
